<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="/static/employer/profile.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">   
</head>
<body>
    <div class="sidebar">
        <div class="text-center mb-4">
            <a class="navbar-brand text-white" href="#"><i class="fas fa-briefcase"></i> Employer Dashboard</a>
        </div>
        <div class="text-center mb-4">
            <div class="profile-picture" >
                <i class="fas fa-user-circle fa-4x text-white" ></i> 
            </div>
        </div>
        <ul class="nav flex-column" id="pills-tab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="pills-dashboard-tab" data-bs-toggle="pill" href="#pills-dashboard" role="tab" aria-controls="pills-dashboard" aria-selected="true"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pills-post-job-tab" data-bs-toggle="pill" href="#pills-post-job" role="tab" aria-controls="pills-post-job" aria-selected="false"><i class="fas fa-plus-circle"></i> Post a Job</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pills-applications-tab" data-bs-toggle="pill" href="#pills-applications" role="tab" aria-controls="pills-applications" aria-selected="false"><i class="fas fa-clipboard-list"></i> Applications</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false"><i class="fas fa-user-cog"></i> Profile</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
        </ul>
    </div>
    <div class="content">
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-dashboard" role="tabpanel" aria-labelledby="pills-dashboard-tab">
                <div class="container">
                    <div id="dashboardCarousel" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="3000">
                        <div class="carousel-inner">
                            <div class="carousel-item active">
                                <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=1200&h=400&auto=format&fit=crop" class="d-block w-100" alt="Slide 1" style="height: 400px; object-fit: cover;">
                                <div class="carousel-caption d-none d-md-block">
                                    <h5>Exciting Job Opportunity</h5>
                                    <p>Join our team today!</p>
                                </div>
                            </div>
                            <div class="carousel-item">
                                <img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=1200&h=400&auto=format&fit=crop" class="d-block w-100" alt="Slide 2" style="height: 400px; object-fit: cover;">
                                <div class="carousel-caption d-none d-md-block">
                                    <h5>Work With Us</h5>
                                    <p>Explore new career paths.</p>
                                </div>
                            </div>
                            <div class="carousel-item">
                                <img src="https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1200&h=400&auto=format&fit=crop" class="d-block w-100" alt="Slide 3" style="height: 400px; object-fit: cover;">
                                <div class="carousel-caption d-none d-md-block">
                                    <h5>Career Growth</h5>
                                    <p>Build your future with us.</p>
                                </div>
                            </div>
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#dashboardCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#dashboardCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                        <div class="carousel-indicators">
                            <button type="button" data-bs-target="#dashboardCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                            <button type="button" data-bs-target="#dashboardCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                            <button type="button" data-bs-target="#dashboardCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                        </div>
                    </div>
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="jobDes"></div>
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-post-job" role="tabpanel" aria-labelledby="pills-post-job-tab">
                <div class="container">
                    <h2 class="mb-4"><i class="fas fa-plus-circle"></i> Post a Job</h2>
                    <a href="/employer/post-job" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Post a Job</a>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-applications" role="tabpanel" aria-labelledby="pills-applications-tab">
                <div class="container">
                    <div id="applicationsContainer"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                <div class="container">
                    <h2 class="mb-4"><i class="fas fa-user-cog"></i> Employer Profile</h2>
                    <form id="employerProfileForm">
                        <div class="mb-3">
                            <label for="username" class="form-label"><i class="fas fa-user"></i> Username</label>
                            <input type="text" class="form-control" id="username" placeholder="Enter your username" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" class="form-control" id="email" placeholder="Enter your email" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="companyName" class="form-label"><i class="fas fa-building"></i> Company Name</label>
                            <input type="text" class="form-control" id="companyName" placeholder="Enter your company name" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="position" class="form-label"><i class="fas fa-user-tie"></i> Position</label>
                            <input type="text" class="form-control" id="position" placeholder="Enter your position" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label"><i class="fas fa-map-marker-alt"></i> Location</label>
                            <input type="text" class="form-control" id="location" placeholder="Enter your location" disabled>
                        </div>
                        <div class="d-flex">
                            <button type="button" id="editProfileBtn" class="btn btn-secondary me-2"><i class="fas fa-edit"></i> Edit Profile</button>
                            <button type="submit" id="saveProfileBtn" class="btn btn-primary" style="display: none;"><i class="fas fa-save"></i> Save Profile</button>
                        </div>
                    </form>
                    <div id="profileMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobDetailsModalLabel"><i class="fas fa-info-circle"></i> Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 id="modalJobTitle"></h4>
                    <p id="modalJobDescription"></p>
                    <p><strong>Location:</strong> <span id="modalJobLocation"></span></p>
                    <p><strong>Salary:</strong> <span id="modalJobSalary"></span></p>
                    <p><strong>Requirements:</strong> <span id="modalJobRequirements"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Close</button>
                    <button type="button" class="btn btn-danger" id="deleteJobBtn"><i class="fas fa-trash"></i> Delete Job</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editJobModal" tabindex="-1" aria-labelledby="editJobModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editJobModalLabel"><i class="fas fa-edit"></i> Edit Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editJobForm">
                        <input type="hidden" id="editJobId">
                        <div class="mb-3">
                            <label for="editJobTitle" class="form-label"><i class="fas fa-briefcase"></i> Job Title</label>
                            <input type="text" class="form-control" id="editJobTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editJobDescription" class="form-label"><i class="fas fa-file-alt"></i> Job Description</label>
                            <textarea class="form-control" id="editJobDescription" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editJobLocation" class="form-label"><i class="fas fa-map-marker-alt"></i> Location</label>
                            <input type="text" class="form-control" id="editJobLocation" required>
                        </div>
                        <div class="mb-3">
                            <label for="editJobSalary" class="form-label"><i class="fas fa-dollar-sign"></i> Salary</label>
                            <input type="text" class="form-control" id="editJobSalary" required>
                        </div>
                        <div class="mb-3">
                            <label for="editJobRequirements" class="form-label"><i class="fas fa-check-circle"></i> Requirements</label>
                            <textarea class="form-control" id="editJobRequirements" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Job</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="/static/config.js"></script>
    <script>   
        const jobDesContainer = document.getElementById("jobDes");
        const applicationsContainer = document.getElementById("applicationsContainer");
        let currentJobId; 
        const API_BASE_URL = window__env.API_BASE_URL;
        const itemsPerPage = 6; 

        const getPostedJobs = async () => {
            try {
                const userId = sessionStorage.getItem("user_id"); 
                const jobRes = await fetch(`${API_BASE_URL}/employer/jobs/${userId}`);
                const data = await jobRes.json();
                jobList(data, 1); // Render the first page by default
            } catch (error) {
                console.error("Error fetching jobs:", error);
            }
        };

        const jobList = (data, page = 1) => {
            jobDesContainer.innerHTML = ""; 

            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            paginatedData.forEach(element => {
                const col = document.createElement("div");
                col.className = "col-md-4 mb-4";

                const card = document.createElement("div");
                card.className = "card h-100 shadow-sm job-card";

                const cardBody = document.createElement("div");
                cardBody.className = "card-body d-flex flex-column";

                const jobTitle = document.createElement("h5");
                jobTitle.className = "card-title";
                jobTitle.innerHTML = `<i class="fas fa-briefcase"></i> ${element.title || "Job Title"}`;

                const jobLocation = document.createElement("p");
                jobLocation.className = "card-text";
                jobLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${element.location || "N/A"}`;

                const applyButton = document.createElement("a");
                applyButton.href = "#";
                applyButton.className = "btn btn-primary me-2";
                applyButton.innerHTML = `<i class="fas fa-eye"></i> View Details`;

                applyButton.addEventListener("click", () => {
                    document.getElementById("modalJobTitle").textContent = element.title || "Job Title";
                    document.getElementById("modalJobDescription").textContent = element.description || "Job Description";
                    document.getElementById("modalJobLocation").textContent = element.location || "N/A";
                    document.getElementById("modalJobSalary").textContent = element.salary || "N/A";
                    document.getElementById("modalJobRequirements").textContent = element.requirements || "N/A";
                    currentJobId = element.job_id;
                    const jobDetailsModal = new bootstrap.Modal(document.getElementById("jobDetailsModal"));
                    jobDetailsModal.show();
                });

                const editButton = document.createElement("button");
                editButton.className = "btn btn-warning";
                editButton.innerHTML = `<i class="fas fa-edit"></i> Edit`;

                editButton.addEventListener("click", () => {
                    document.getElementById("editJobTitle").value = element.title || "";
                    document.getElementById("editJobDescription").value = element.description || "";
                    document.getElementById("editJobLocation").value = element.location || "";
                    document.getElementById("editJobSalary").value = element.salary || "";
                    document.getElementById("editJobRequirements").value = element.requirements || "";
                    document.getElementById("editJobId").value = element.job_id;

                    const editJobModal = new bootstrap.Modal(document.getElementById("editJobModal"));
                    editJobModal.show();
                });

                const buttonContainer = document.createElement("div");
                buttonContainer.className = "d-flex justify-content-between mt-3";
                buttonContainer.append(applyButton, editButton);

                cardBody.append(jobTitle, jobLocation, buttonContainer);
                card.append(cardBody);
                col.append(card);
                jobDesContainer.append(col);
            });
            renderPagination(data, page);
        };

        const renderPagination = (data, currentPage) => {
            const totalPages = Math.ceil(data.length / itemsPerPage);
            const paginationContainer = document.getElementById("pagination");
            paginationContainer.innerHTML = "";

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li");
                li.className = `page-item ${i === currentPage ? "active" : ""}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;

                li.addEventListener("click", (e) => {
                    e.preventDefault();
                    jobList(data, i);
                });

                paginationContainer.appendChild(li);
            }
        };

        document.getElementById("editJobForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const jobId = document.getElementById("editJobId").value;
            const updatedJob = {
                title: document.getElementById("editJobTitle").value,
                description: document.getElementById("editJobDescription").value,
                location: document.getElementById("editJobLocation").value,
                salary: document.getElementById("editJobSalary").value,
                requirements: document.getElementById("editJobRequirements").value,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/employer/edit_job/${jobId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedJob),
                });

                const result = await response.json();
                alert(result.message); 

                const editJobModal = bootstrap.Modal.getInstance(document.getElementById("editJobModal"));
                editJobModal.hide();

                jobDesContainer.innerHTML = ""; 
                getPostedJobs(); 
            } catch (error) {
                console.error("Error updating job:", error);
            }
        });

        document.getElementById("deleteJobBtn").addEventListener("click", async () => {
            if (currentJobId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/employer/delete_job/${currentJobId}`, {
                        method: 'DELETE',
                    });

                    const result = await response.json();
                    alert(result.message);

                    jobDesContainer.innerHTML = ""; 
                    getPostedJobs(); 
                 
                    const jobDetailsModal = bootstrap.Modal.getInstance(document.getElementById("jobDetailsModal"));
                    jobDetailsModal.hide();
                } catch (error) {
                    console.error("Error deleting job:", error);
                    alert("Failed to delete job.");
                }
            }
        });

        async function fetchApplicationDetails() {
            try {
                const userId = sessionStorage.getItem("user_id"); 
                if (!userId) throw new Error("User  ID not found in session storage");

                const response = await fetch(`${API_BASE_URL}/employer/view_application_details/${userId}`);
                if (!response.ok) throw new Error("Failed to fetch application details");

                const data = await response.json(); 
                renderApplications(data);
            } catch (error) {
                console.error("Error fetching application details:", error);
            }
            
        }

        function renderApplications(data) {
            const container = document.getElementById("applicationsContainer");
            container.innerHTML = ""; 
            
            if (data.applications.length === 0) {
                container.innerHTML = "<p>No applications found.</p>";
                return;
            }
            
            data.applications.forEach((application, index) => {
                const job = data.jobs.find(job => job.job_id === application.job_id);
                const user = data.users.find(user => user.user_id === application.user_id);
                
                const card = document.createElement("div");
                card.className = "card mb-3 application-card";
                
                card.innerHTML = ` 
                    <div class="card-body">
                        <h3>Application ${index + 1}</h3>   
                        <p><strong class="username"><i class="fas fa-user"></i> Username:</strong> ${user ? user.username : "Unknown"}</p>
                        <p><strong class="email"><i class="fas fa-envelope"></i> Email:</strong> ${user ? user.email : "Unknown"}</p>
                        <p><strong class="job-title"><i class="fas fa-briefcase"></i> Job Title:</strong> ${job ? job.title : "Unknown"}</p>
                        <p><strong>Description:</strong> ${job ? job.description : "N/A"}</p>
                        <p><strong>Skills:</strong> ${job && job.skills ? job.skills.join(", ") : "N/A"}</p>
                        <p><strong>Salary:</strong> ${job ? job.salary : "N/A"}</p>
                        <p><strong>Location:</strong> ${job ? job.location : "N/A"}</p>
                        <p><strong class="status"><i class="fas fa-info-circle"></i> Status:</strong> ${application.status || "Pending"}</p>
                        <select class="form-select mb-3" id="status-${application.job_id}-${application.user_id}">
                            <option value="under_review" ${application.status === "under_review" ? "selected" : ""}>Under Review</option>
                            <option value="hired" ${application.status === "hired" ? "selected" : ""}>Hired</option>
                            <option value="rejected" ${application.status === "rejected" ? "selected" : ""}>Rejected</option>
                        </select>       
                        <button class="btn btn-primary" onclick="updateStatus('${application.job_id}', '${application.user_id}')"><i class="fas fa-sync-alt"></i> Update Status</button>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        async function updateStatus(jobId, userId) {
            const statusSelect = document.getElementById(`status-${jobId}-${userId}`);
            const status = statusSelect.value;

            try {
                const response = await fetch(`${API_BASE_URL}/employer/update_application_status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        job_id: jobId,
                        user_id: userId,
                        status: status,
                    }),
                });

                const result = await response.json();
                alert(result.message);

                const cardToRemove = document.querySelector(`#status-${jobId}-${userId}`).closest('.card');
                if (cardToRemove) {
                    cardToRemove.remove();
                } 

                fetchApplicationDetails();
            } catch (error) {
                console.error("Error updating application status:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            setInterval(() => {
                fetchApplicationDetails();
                getPostedJobs();
            }, 2000);

            fetchApplicationDetails();
            getPostedJobs();
        });
    </script>
</body>
</html>